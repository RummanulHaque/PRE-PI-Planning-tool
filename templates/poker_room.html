{% extends "base.html" %}
{% block content %}

{% macro fid(name) -%}
{{ name|replace(' ', '-')|replace('/', '-')|trim }}
{%- endmacro %}

<div class="card" style="padding:22px; border:1px solid #1e293b; border-radius:16px; background:#0f172a;">
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
    <div>
      <div style="color:#86BC25; font-weight:900; font-size:12px;">{{ feature_id }}</div>
      <h2 style="margin:6px 0 0 0;">{{ feature_name }}</h2>
      <div style="margin-top:6px; color:#94a3b8; font-size:12px;">
        You are: <span style="color:#cbd5f5; font-weight:800;">{{ username }}</span>
        {% if is_host %}
          <span style="margin-left:8px; padding:3px 8px; border-radius:999px; background:#86BC25; color:#0b1220; font-weight:900;">HOST</span>
        {% endif %}
        <br/>
        Host: <span style="color:#cbd5f5; font-weight:800;">{{ host_name }}</span> â€¢
        Session: <span style="color:#cbd5f5;">{{ session_id }}</span>
      </div>
    </div>

    <div style="text-align:right;">
      <a href="/wsjf" style="color:#cbd5f5; text-decoration:underline;">Back to WSJF</a>
    </div>
  </div>

  <hr style="border:none; border-top:1px solid #1e293b; margin:16px 0;" />

  <div style="display:flex; gap:10px; flex-wrap:wrap; color:#94a3b8; font-size:12px;">
    <div>Participants:</div>
    {% for u in users %}
      <div style="padding:4px 8px; border:1px solid #1e293b; border-radius:999px; background:#0b1220; color:#cbd5f5;">
        {{ u }}
      </div>
    {% endfor %}
  </div>

  <div style="margin-top:18px;">
    {% for field in fields %}
      {% set id = fid(field) %}

      <div style="margin-bottom:18px; padding:14px; border:1px solid #1e293b; border-radius:14px; background:#0b1220;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
          <div>
            <h3 style="margin:0; color:#86BC25;">{{ field }}</h3>
            <div style="margin-top:6px; color:#94a3b8; font-size:12px;">
              Your selection:
              <span id="your-{{ id }}" style="color:#cbd5f5; font-weight:900;">
                {% if your_votes[field] %}
                  {{ your_votes[field] }}
                {% else %}
                  â€”
                {% endif %}
              </span>
            </div>
          </div>

          <div style="text-align:right;">
            <div style="color:#94a3b8; font-size:12px;">Voting status</div>
            <div id="status-{{ id }}" style="margin-top:6px; color:#cbd5f5; font-size:12px;">
              â€”
            </div>
          </div>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          {% for v in fibo %}
            <button onclick="vote('{{ id }}', '{{ field }}', {{ v }})"
                    style="padding:10px 12px; border-radius:12px; border:1px solid #1e293b;
                           background:#0f172a; color:#f1f5f9; cursor:pointer; font-weight:800;">
              {{ v }}
            </button>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>

  <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
    {% if is_host %}
      <button onclick="reveal()"
              style="padding:10px 14px; border-radius:12px; border:1px solid #86BC25;
                     background:#0b1220; color:#86BC25; font-weight:900; cursor:pointer;">
        Reveal Consensus
      </button>

      <button onclick="commit()"
              style="padding:10px 14px; border-radius:12px; border:1px solid #86BC25;
                     background:#86BC25; color:#0b1220; font-weight:900; cursor:pointer;">
        Commit to WSJF
      </button>
    {% else %}
      <div style="color:#94a3b8; font-size:12px;">
        Waiting for host to <span style="color:#cbd5f5; font-weight:800;">reveal</span> and <span style="color:#cbd5f5; font-weight:800;">commit</span>.
      </div>
    {% endif %}
  </div>

  <pre id="result"
       style="margin-top:16px; padding:14px; border-radius:14px; border:1px solid #1e293b;
              background:#0b1220; color:#cbd5f5; white-space:pre-wrap;"></pre>
</div>

<script>
const SESSION_ID = "{{ session_id }}";

function vote(id, field, val){
  // optimistic update (instant)
  const el = document.getElementById("your-" + id);
  if(el) el.textContent = val;

  fetch("/api/vote", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ session: SESSION_ID, field: field, value: val })
  })
  .then(r => r.json())
  .then(res => {
    if(res.error){ alert(res.error); return; }
    setTimeout(refreshState, 200);
  });
}

function reveal(){
  fetch("/api/reveal/" + SESSION_ID)
    .then(r => r.json())
    .then(data => {
      if(data.error){ alert(data.error); return; }
      document.getElementById("result").textContent =
        "Consensus (avg â†’ nearest Fibonacci):\n\n" + JSON.stringify(data, null, 2);
      refreshState();
    });
}

function commit(){
  fetch("/api/commit/" + SESSION_ID)
    .then(r => r.json())
    .then(res => {
      if(res.error){ alert(res.error); return; }
      alert("Saved to Excel. Going back to WSJFâ€¦");
      window.location.href = "/wsjf";
    });
}

function refreshState(){
  fetch("/api/state/" + SESSION_ID)
    .then(r => r.json())
    .then(state => {
      if(state.error){ return; }

      Object.keys(state.fields).forEach(fieldName => {
        const f = state.fields[fieldName];
        const id = fieldName.replace(/[\s\/]/g,'-').trim();

        const voted = f.voted_users || [];
        const total = state.users ? state.users.length : 0;
        const pending = total - voted.length;

        const statusEl = document.getElementById("status-" + id);
        if(statusEl){
          statusEl.textContent = `${voted.length}/${total} voted â€¢ ${pending} pending`;
        }

        const yourEl = document.getElementById("your-" + id);
        if(yourEl){
          yourEl.textContent = (f.your_value && f.your_value !== 0) ? f.your_value : "â€”";
        }
      });

      if(state.revealed){
  const box = document.getElementById("result");
  let html = "ðŸ” Estimation Results\n\n";

  Object.keys(state.fields).forEach(field => {
    const f = state.fields[field];
    const votes = f.values || {};
    const consensus = (state.consensus || {})[field];

    html += field + "\n";

    if(Object.keys(votes).length > 0){
      Object.keys(votes).forEach(u => {
        html += "  â€¢ " + u + ": " + votes[u] + "\n";
      });
    } else {
      html += "  â€¢ No votes\n";
    }

    html += "  âžœ Consensus: " + (consensus ?? "â€”") + "\n\n";
  });

  box.textContent = html;
}
    });
}

refreshState();
setInterval(refreshState, 2000);
</script>

{% endblock %}
