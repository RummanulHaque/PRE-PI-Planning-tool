{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
    .drop-zone { min-height: 100px; background: rgba(255,255,255,0.02); border: 1px solid #1e293b; }
    .feature-item { background: #1e293b; border: 1px solid #3b82f6; padding: 10px; margin: 5px; border-radius: 6px; cursor: grab; font-size: 12px; }
    #context-menu { display: none; position: absolute; background: #161c2d; border: 1px solid #334155; border-radius: 8px; width: 180px; z-index: 3000; }
    .menu-item { padding: 10px; color: #cbd5f5; cursor: pointer; font-size: 13px; }
    .menu-item:hover { background: #1e293b; color: #86BC25; }
</style>

<div style="display: flex; gap: 20px;">
    <div style="width: 250px; background: #161c2d; padding: 20px; border-radius: 12px; border: 1px solid #1e293b;">
        <h3 style="margin-top: 0;">Feature Bank</h3>
        <div id="bank" style="min-height: 500px;">
            {% for f in features %}
            <div class="feature-item" data-name="{{ f.name }}"><strong>{{ f.name }}</strong></div>
            {% endfor %}
        </div>
    </div>
    <div style="flex-grow: 1;">
        <table width="100%" style="border-collapse: collapse; color: #fff; table-layout: fixed;">
            <thead><tr style="background: #000;"><th style="width: 150px;">Story Points</th>{% for i in range(1, 7) %}<th>Sprint {{ i }}</th>{% endfor %}</tr></thead>
            <tbody>
                {% for sp in range(1, 5) %}
                <tr>
                    <td style="background: #0f172a; padding: 15px; border: 1px solid #334155; color: #86BC25; font-weight: bold; text-align: center;">Story Point {{ sp }}</td>
                    {% for i in range(1, 7) %}<td class="drop-zone" style="border: 1px solid #334155;"></td>{% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="context-menu">
    <div class="menu-item" onclick="splitFeature(2)">Split into 2 Parts</div>
    <div class="menu-item" onclick="splitFeature(3)">Split into 3 Parts</div>
</div>

<script>
    let rightClickedItem = null;
    document.addEventListener('contextmenu', e => {
        const item = e.target.closest('.feature-item');
        if (item) {
            e.preventDefault();
            rightClickedItem = item;
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px';
        } else { document.getElementById('context-menu').style.display = 'none'; }
    });
    document.addEventListener('click', () => document.getElementById('context-menu').style.display = 'none');

    function splitFeature(parts) {
        const name = rightClickedItem.getAttribute('data-name');
        const parent = rightClickedItem.parentNode;
        rightClickedItem.remove();
        for (let i = 1; i <= parts; i++) {
            const div = document.createElement('div');
            div.className = 'feature-item';
            div.innerHTML = `<strong>${name} (P${i})</strong>`;
            parent.appendChild(div);
        }
    }

    const zones = [document.getElementById('bank'), ...document.querySelectorAll('.drop-zone')];
    zones.forEach(z => new Sortable(z, { group: 'pi', animation: 150 }));
</script>
{% endblock %}