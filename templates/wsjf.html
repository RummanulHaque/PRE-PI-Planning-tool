{% extends "base.html" %}
{% block content %}

{% for f in features %}
<div class="card" style="position:relative; margin-bottom:25px; border-left: 5px solid {{ '#86BC25' if f['WSJF'] > 0 else '#334155' }};">
    
    <div style="position:absolute; right:20px; top:20px; text-align:right;">
        <button onclick="openPoker('{{ f['Feature Name'] }}', '{{ f['Feature ID'] }}', {{ f['Business Value'] or 0 }}, {{ f['Time Complexity'] or 0 }}, {{ f['OE/RR Value'] or 0 }}, {{ f['Job Size'] or 1 }})" 
                style="background: #86BC25; color: black; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
            Planning Poker
        </button>
        <div style="margin-top:15px; font-size:11px; color:#94a3b8;">WSJF SCORE</div>
        <div style="font-size:32px; font-weight:800; color:{{ '#86BC25' if f['WSJF'] > 0 else '#475569' }};">
            {{ f["WSJF"] if f["WSJF"] > 0 else "0.00" }}
        </div>
    </div>

    <div style="color:#86BC25; font-size:12px; font-weight:bold;">{{ f["Feature ID"] }}</div>
    <h3 style="margin: 8px 0; color: #fff;">{{ f["Feature Name"] }}</h3>
    <p style="color:#cbd5f5; max-width:70%; font-size:14px;">{{ f["Feature Description"] }}</p>

    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px solid #1e293b; max-width: 70%;">
        <pre style="color:#94a3b8; font-size:12px; margin:0; white-space: pre-wrap; font-family: inherit;">{{ f["Feature Acceptance Criteria"] }}</pre>
    </div>

    <div style="display:flex; gap:25px; margin-top:20px; padding-top: 15px; border-top: 1px solid #1e293b;">
        <div style="text-align: center;"><div style="font-size: 10px; color: #94a3b8;">BV</div><div style="color: white; font-weight: bold;">{{ f['Business Value']|int }}</div></div>
        <div style="text-align: center;"><div style="font-size: 10px; color: #94a3b8;">TC</div><div style="color: white; font-weight: bold;">{{ f['Time Complexity']|int }}</div></div>
        <div style="text-align: center;"><div style="font-size: 10px; color: #94a3b8;">RROE</div><div style="color: white; font-weight: bold;">{{ f['OE/RR Value']|int }}</div></div>
        <div style="text-align: center; border-left: 1px solid #334155; padding-left: 20px;"><div style="font-size: 10px; color: #86BC25;">JOB SIZE</div><div style="color: #86BC25; font-weight: bold;">{{ f['Job Size']|int }}</div></div>
    </div>
</div>
{% endfor %}

<div id="pokerModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); align-items:center; justify-content:center;">
    <div style="background:#161c2d; padding:35px; border-radius:15px; width:480px; border:1px solid #334155;">
        <h3 id="mTitle" style="color:#fff; margin-top:0;">Planning Poker</h3>
        <p id="mID" style="color:#86BC25; font-size:12px; margin-top:-10px; margin-bottom: 25px;"></p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div><label style="font-size:11px; color:#94a3b8;">Business Value</label><input type="number" id="mBV" style="width:100%; padding:10px; background:#0b1220; border:1px solid #334155; color:white; border-radius:6px;"></div>
            <div><label style="font-size:11px; color:#94a3b8;">Time Complexity</label><input type="number" id="mTC" style="width:100%; padding:10px; background:#0b1220; border:1px solid #334155; color:white; border-radius:6px;"></div>
            <div><label style="font-size:11px; color:#94a3b8;">RROE Value</label><input type="number" id="mRROE" style="width:100%; padding:10px; background:#0b1220; border:1px solid #334155; color:white; border-radius:6px;"></div>
            <div><label style="font-size:11px; color:#86BC25;">Job Size</label><input type="number" id="mSize" style="width:100%; padding:10px; background:#0b1220; border:1px solid #86BC25; color:white; border-radius:6px;"></div>
        </div>
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button onclick="savePoker()" style="flex: 2; background:#86BC25; color:black; padding:14px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Submit Consensus</button>
            <button onclick="document.getElementById('pokerModal').style.display='none'" style="flex: 1; background:#334155; color:white; padding:14px; border:none; border-radius:8px; cursor:pointer;">Cancel</button>
        </div>
    </div>
</div>

<script>
let currentID;
function openPoker(name, id, bv, tc, rroe, size) {
    currentID = id;
    document.getElementById('mTitle').innerText = name;
    document.getElementById('mID').innerText = id;
    document.getElementById('mBV').value = bv;
    document.getElementById('mTC').value = tc;
    document.getElementById('mRROE').value = rroe;
    document.getElementById('mSize').value = size;
    document.getElementById('pokerModal').style.display = 'flex';
}
async function savePoker() {
    const payload = {
        id: currentID,
        bv: parseInt(document.getElementById('mBV').value),
        tc: parseInt(document.getElementById('mTC').value),
        rroe: parseInt(document.getElementById('mRROE').value),
        size: parseInt(document.getElementById('mSize').value)
    };
    const response = await fetch('/save_poker', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    if (response.ok) { window.location.reload(); }
}
</script>
{% endblock %}